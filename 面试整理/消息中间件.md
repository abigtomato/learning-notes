# 消息中间件

## MQ的优缺点

**优点**：

* **异步处理**：相对于传统的串行执行，提高了系统吞吐量。
* **应用解耦**：系统间通过消息通信，断开了相互的强依赖性。
* **流量削锋**：通过队列的长度控制请求量，缓解短时间内的高并发请求。
* **日志处理**：解决大量日志传输。
* **消息通讯**：消息队列一般都会内置高效的通信机制，因此也可以用在纯消息通信上，如实现点对点消息队列或者聊天室等。

**缺点**：

* **系统可用性降低**：若消息队列挂了，会影响相应的业务程序的执行。
* **系统复杂度提高**：加入消息队列需要考虑更多的问题，如一致性问题、消息重复消费问题、消息可靠性问题，导致系统复杂性提高。
* **一致性问题**：分布式系统环境下，业务逻辑的作用域横跨多个系统，相互之间通过消息队列异步协作。若其中一个系统操作失败，那么整套逻辑执行后就会出现数据不一致的情况。



## 多种MQ的对比

![img](assets/20200314161912523.png)

 

## MQ的常见问题

**消息的顺序问题**：

* 问题：所谓消息的有序性是指消费方按照消息的发送顺序来消费。如下图，生产者要求消息M1要先于M2被消费，但MQ是以集群部署，不同的服务器发送顺序不同。

  ![img](assets/20200314161955861.png)

* 解决方案：保证生产者、MQ Server和消费者是一对一的关系。

  ![img](assets/20200314162007207.png)

* 解决方案的缺点：

  * 并行度就会成为MQ系统的性能瓶颈。
  * 会出现更多的异常，若一方出现问题，就会导致整个处理流程阻塞。
  * 队列无序并不意味着消息无序，所以从业务层面保证消息的顺序而不仅仅是依赖于消息系统，是一种更合理的方式。

**消息的重复问题**：

* 问题：由于网络不可达原因导致的消费端收到两条一样的消息。
* 解决方案：消费端处理消息的业务逻辑必须保证前后的幂等性，即保证每条消息都有唯一编号且与去重表的日志同时出现，利用一张日志表来记录已经处理成功的消息ID，如果新到来的消息ID已经存在于表中了，那么就不需要再次处理这条消息了。



## RabbitMQ基本概念

* **Broker**：消息队列服务器实体。
* **Exchange**：消息交换机，用于指定消息的路由规则。
* **Queue**：消息队列载体，每个消息都会被投递到一个或多个队列中。
* **Binding**：绑定关系，就是将交换机和队列按照路由规则绑定起来。
* **Routing Key**：路由关键字，交换机会根据关键字进行消息的投递。
* **VHost**：即虚拟的Broker主机，也就是一套虚拟出的消息系统，内部含有独立的Queue、Exchange和Binding等，更重要的是其拥有一套独立的权限系统，可以做到VHost范围的用户控制。这让RabbitMQ可以使用VHost作为不同权限的隔离手段，典型的例子就是不同应用可以运行在不同的VHost中。
* **Producer**：消息生产者，也就是投递消息的程序。
* **Consumer**：消息消费者，也就是接受消息的程序。
* **Channel**：消息通道，在客户端的每个连接里，可以创建多个Channel，每个通道都代表一个会话任务。
* 由Exchange、Queue和Routing Key三个角色共同决定消息的投递线路。



## RabbitMQ工作模式

* simple：
* work：
* publish/subscribe：
* routing：
* topic：



## RabbitMQ消息可靠性



## RabbitMQ集群高可用