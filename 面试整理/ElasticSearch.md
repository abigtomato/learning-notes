# ElasticSearch

## 基本概念

* Cluster：集群，有多个节点，其中有一个为主节点，这个主节点是可以通过选举产生的，主从节点是相对于集群内部来说。es的一个概念就是去中心化，字面上理解就是无中心节点，这是对于集群外部来说的，因为从外部来看es集群，在逻辑上是个整体，与任意节点的通信和与整个es集群通信是等价的。
* Shards：索引分片，es可以把一个完整的索引分成多个分片，好处是可以把一个大的索引拆分成多个小的，然后分布到不同的节点上，构成分布式存储。分片的数量只能在索引创建前指定，并且索引创建后不能更改。当进行水平扩容时，需要重新设置分片数量，重新导入数据。
* Replicas：索引副本，es可以设置多个索引的副本，副本的作用一是提高系统的容错性，当某个节点某个分片损坏或丢失时可以从副本中恢复；二是提高es的查询效率，es会自动对搜索请求进行负载均衡。 
* Recovery：数据恢复或数据重分布，es集群在有节点加入或退出时会根据机器的负载对索引分片进行重新分配，挂掉的节点重新启动时也会进行数据恢复。 
* River：es的数据源，也是其它存储方式（如：数据库）同步数据到es的一个方法。它是以插件方式存在的服务，通过读取river中的数据并把它在es中建立索引。
* Gateway：es索引快照的存储方式，es默认是先把索引存放到内存中，当内存满了再持久化到本地硬盘。当es集群关闭再重新启动时就会从gateway中读取索引备份数据。es支持多种类型的gateway，有本地文件系统（默认），分布式文件系统，Hadoop的HDFS和Amazon的S3云存储服务。
* Discovery.zen：代表es的自动发现节点机制，es是一个基于p2p的系统，它先通过广播寻找存在的节点，再通过广播协议来进行节点之间的通信，同时也支持点对点的交互。 
* Transport：代表es内部节点或集群与客户端的交互方式，默认内部是使用tcp协议进行交互，同时它支持http协议（json格式），Thrift，Servlet，Memcached，ZeroMQ等的传输协议（通过插件方式集成）。



## 倒排索引

对存储的数据分词抽取出其中的各个词条，以词条为key，对应数据的出现位置为value。搜索时，对关键字分词，通过词条匹配倒排索引，获取词条在原始数据中出现的位置，以位置作为条件搜索。

* 数据表：

| 商品主键 |  商品名  |    商品描述    |
| :------: | :------: | :------------: |
|    1     |  荣耀10  |   更贵的手机   |
|    2     |  荣耀8   | 相对便宜的手机 |
|    3     | iphone11 | 要卖肾买的手机 |

* 倒排索引表：

| 词条（key） | 数据（value） |
| :---------: | :-----------: |
|    手机     |    1, 2, 3    |
|    便宜     |       2       |
|    卖肾     |       3       |
|    相对     |       2       |
|    荣耀     |     1, 2      |
|   iphone    |       3       |



## 存储概念

* Index：索引，包含若干相似结构的document数据，如：客户索引，订单索引，商品索引等，一个index包含多个document，代表一类相似的或相同的document，如：订单索引中存放了所有的订单数据。
* Type：类型，每个索引中都可以有一个Type，Type是Index中的一个逻辑分类，同一个Type中的Document都有相同的field。示例：订单索引，不同状态的订单包含不同的内容，如：未支付订单（自动取消时间）和已支付订单（支付时间）、已发货订单（发货时间、物流信息）等都有不同的内容。
* Document：文档是ES中的最小数据单元，一个Document就是一条数据，一般使用json数据结构表示，每个Index下的Type中都可以存储多个Document，一个Document中有多个field，field就是数据字段。



## ES和关系数据库对比

|      ES       | 数据库系统  |
| :-----------: | :---------: |
|  Index 索引   | Database 库 |
|   Type 类型   |  Table 表   |
| Document 文档 |   Row 行    |
|  Field 字段   |  Column 列  |
